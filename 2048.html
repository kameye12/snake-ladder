<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>2048 Online</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Kanit", sans-serif;
        background-color: #faf8ef;
        color: #776e65;
        text-align: center;
        margin: 0;
        padding: 20px;
        overflow: hidden; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏î */
        touch-action: none;
      }

      .home-btn {
        position: fixed;
        top: 10px;
        left: 10px;
        background: #8f7a66;
        color: white;
        padding: 8px 15px;
        text-decoration: none;
        border-radius: 5px;
        font-size: 14px;
        z-index: 100;
      }

      h1 {
        font-size: 60px;
        margin: 0;
        color: #776e65;
      }

      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        max-width: 400px;
        margin: 10px auto;
      }

      .score-box {
        background: #bbada0;
        color: white;
        padding: 5px 15px;
        border-radius: 5px;
        text-align: center;
        min-width: 80px;
      }
      .score-label {
        font-size: 12px;
        color: #eee4da;
      }
      .score-val {
        font-size: 20px;
        font-weight: bold;
      }

      /* ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÄ‡∏Å‡∏° */
      #game-board {
        position: relative;
        background: #bbada0;
        width: 100%;
        max-width: 400px;
        aspect-ratio: 1/1;
        margin: 0 auto;
        border-radius: 10px;
        padding: 10px;
        box-sizing: border-box;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
        gap: 10px;
      }

      /* ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÜ (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á) */
      .grid-cell {
        background: rgba(238, 228, 218, 0.35);
        border-radius: 5px;
        width: 100%;
        height: 100%;
      }

      /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Tile) */
      .tile {
        position: absolute;
        background: #eee4da;
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 30px;
        transition: all 0.15s ease-in-out;
        z-index: 10;
      }

      /* ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏•‡∏Ç */
      .tile-2 {
        background: #eee4da;
        color: #776e65;
      }
      .tile-4 {
        background: #ede0c8;
        color: #776e65;
      }
      .tile-8 {
        background: #f2b179;
        color: white;
      }
      .tile-16 {
        background: #f59563;
        color: white;
      }
      .tile-32 {
        background: #f67c5f;
        color: white;
      }
      .tile-64 {
        background: #f65e3b;
        color: white;
      }
      .tile-128 {
        background: #edcf72;
        color: white;
        font-size: 24px;
        box-shadow: 0 0 10px #edcf72;
      }
      .tile-256 {
        background: #edcc61;
        color: white;
        font-size: 24px;
        box-shadow: 0 0 10px #edcc61;
      }
      .tile-512 {
        background: #edc850;
        color: white;
        font-size: 24px;
        box-shadow: 0 0 10px #edc850;
      }
      .tile-1024 {
        background: #edc53f;
        color: white;
        font-size: 20px;
        box-shadow: 0 0 15px #edc53f;
      }
      .tile-2048 {
        background: #edc22e;
        color: white;
        font-size: 20px;
        box-shadow: 0 0 20px #edc22e;
      }

      /* Animation */
      .tile-new {
        animation: pop 0.2s;
      }
      .tile-merged {
        animation: pop 0.2s;
        z-index: 20;
      }

      @keyframes pop {
        0% {
          transform: scale(0);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      #game-over-screen {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(238, 228, 218, 0.73);
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 50;
        border-radius: 10px;
      }
      #restart-btn {
        background: #8f7a66;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
      }

      .leaderboard {
        margin-top: 20px;
        background: #bbada0;
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
      }
    </style>
  </head>
  <body>
    <a href="/" class="home-btn">üè† Home</a>

    <div class="header-container">
      <h1>2048</h1>
      <div class="score-box">
        <div class="score-label">SCORE</div>
        <div class="score-val" id="score">0</div>
      </div>
      <div class="score-box">
        <div class="score-label">BEST</div>
        <div class="score-val" id="best-score">0</div>
      </div>
    </div>

    <div id="game-board">
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>
      <div class="grid-cell"></div>

      <div id="tile-container"></div>

      <div id="game-over-screen">
        <h2 style="font-size: 40px; color: #776e65">Game Over!</h2>
        <button id="restart-btn">Try Again</button>
      </div>
    </div>

    <div class="leaderboard">
      <h3>üèÜ Live Scores</h3>
      <div id="lb-list">...</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io("/2048", { transports: ["websocket"] });

      const boardEl = document.getElementById("game-board");
      const tileContainer = document.getElementById("tile-container");
      const scoreEl = document.getElementById("score");
      const bestScoreEl = document.getElementById("best-score");
      const gameOverScreen = document.getElementById("game-over-screen");
      const restartBtn = document.getElementById("restart-btn");

      let grid = [];
      let score = 0;
      let bestScore = 0;
      const size = 4;

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
      function initGame() {
        grid = Array(size)
          .fill()
          .map(() => Array(size).fill(0));
        score = 0;
        scoreEl.innerText = 0;
        gameOverScreen.style.display = "none";
        tileContainer.innerHTML = "";

        addNewTile();
        addNewTile();
        updateView();
      }

      function addNewTile() {
        let emptyCells = [];
        for (let r = 0; r < size; r++) {
          for (let c = 0; c < size; c++) {
            if (grid[r][c] === 0) emptyCells.push({ r, c });
          }
        }
        if (emptyCells.length > 0) {
          let rand = emptyCells[Math.floor(Math.random() * emptyCells.length)];
          grid[rand.r][rand.c] = Math.random() < 0.9 ? 2 : 4;
        }
      }

      // --- Logic ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î ---
      function updateView() {
        tileContainer.innerHTML = "";
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á
        const cellWidth = (boardEl.clientWidth - 50) / 4;

        for (let r = 0; r < size; r++) {
          for (let c = 0; c < size; c++) {
            let val = grid[r][c];
            if (val > 0) {
              let tile = document.createElement("div");
              tile.className = `tile tile-${val} tile-new`;
              tile.innerText = val;

              // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Absolute)
              // padding 10px, gap 10px
              let top = 10 + r * (cellWidth + 10);
              let left = 10 + c * (cellWidth + 10);

              tile.style.width = `${cellWidth}px`;
              tile.style.height = `${cellWidth}px`;
              tile.style.top = `${top}px`;
              tile.style.left = `${left}px`;

              tileContainer.appendChild(tile);
            }
          }
        }
      }

      // --- Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á 2048) ---
      function move(direction) {
        let moved = false;
        // ‡∏Å‡πá‡∏≠‡∏õ‡∏õ‡∏µ‡πâ grid ‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡∏´‡∏°‡∏∏‡∏ô‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡πà‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢)
        // ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏°‡∏∏‡∏ô‡∏Å‡∏•‡∏±‡∏ö

        const rotateGrid = (mat) =>
          mat[0].map((val, index) => mat.map((row) => row[index]).reverse());

        // ‡∏´‡∏°‡∏∏‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô "‡∏ã‡πâ‡∏≤‡∏¢"
        let tempGrid = JSON.parse(JSON.stringify(grid));
        if (direction === "up")
          tempGrid = rotateGrid(rotateGrid(rotateGrid(tempGrid))); // ‡∏´‡∏°‡∏∏‡∏ô 270
        if (direction === "right") tempGrid = rotateGrid(rotateGrid(tempGrid)); // ‡∏´‡∏°‡∏∏‡∏ô 180
        if (direction === "down") tempGrid = rotateGrid(tempGrid); // ‡∏´‡∏°‡∏∏‡∏ô 90

        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ (Slide Left)
        for (let r = 0; r < size; r++) {
          let row = tempGrid[r].filter((val) => val !== 0); // ‡πÄ‡∏≠‡∏≤ 0 ‡∏≠‡∏≠‡∏Å

          // ‡∏£‡∏ß‡∏°‡πÄ‡∏•‡∏Ç (Merge)
          for (let i = 0; i < row.length - 1; i++) {
            if (row[i] === row[i + 1]) {
              row[i] *= 2;
              score += row[i];
              row[i + 1] = 0;
            }
          }
          row = row.filter((val) => val !== 0); // ‡πÄ‡∏≠‡∏≤ 0 ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏≠‡∏≠‡∏Å
          while (row.length < 4) row.push(0); // ‡πÄ‡∏ï‡∏¥‡∏° 0 ‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4

          if (JSON.stringify(tempGrid[r]) !== JSON.stringify(row)) moved = true;
          tempGrid[r] = row;
        }

        // ‡∏´‡∏°‡∏∏‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô
        if (direction === "up") tempGrid = rotateGrid(tempGrid);
        if (direction === "right") tempGrid = rotateGrid(rotateGrid(tempGrid));
        if (direction === "down")
          tempGrid = rotateGrid(rotateGrid(rotateGrid(tempGrid)));

        if (moved) {
          grid = tempGrid;
          addNewTile();
          updateView();
          scoreEl.innerText = score;

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
          if (score > bestScore) {
            bestScore = score;
            bestScoreEl.innerText = bestScore;
          }
          socket.emit("updateScore", score);

          if (checkGameOver()) {
            gameOverScreen.style.display = "flex";
          }
        }
      }

      function checkGameOver() {
        for (let r = 0; r < size; r++) {
          for (let c = 0; c < size; c++) {
            if (grid[r][c] === 0) return false;
            if (c < 3 && grid[r][c] === grid[r][c + 1]) return false;
            if (r < 3 && grid[r][c] === grid[r + 1][c]) return false;
          }
        }
        return true;
      }

      // --- Controls (Keyboard & Touch) ---
      document.addEventListener("keydown", (e) => {
        if (
          ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)
        ) {
          e.preventDefault();
          move(e.key.replace("Arrow", "").toLowerCase());
        }
      });

      // Touch Swipe
      let touchStartX = 0;
      let touchStartY = 0;
      boardEl.addEventListener(
        "touchstart",
        (e) => {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
        },
        { passive: false }
      );

      boardEl.addEventListener(
        "touchend",
        (e) => {
          e.preventDefault(); // ‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
          let touchEndX = e.changedTouches[0].clientX;
          let touchEndY = e.changedTouches[0].clientY;

          let dx = touchEndX - touchStartX;
          let dy = touchEndY - touchStartY;

          if (Math.abs(dx) > Math.abs(dy)) {
            if (Math.abs(dx) > 30) move(dx > 0 ? "right" : "left");
          } else {
            if (Math.abs(dy) > 30) move(dy > 0 ? "down" : "up");
          }
        },
        { passive: false }
      );

      restartBtn.addEventListener("click", initGame);
      window.addEventListener("resize", updateView); // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô

      // Socket Leaderboard
      socket.on("updateLeaderboard", (scores) => {
        let list = Object.entries(scores)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .map(
            ([id, s], i) =>
              `<div>${i + 1}. ${
                id === socket.id ? "YOU" : "Player"
              } : ${s}</div>`
          )
          .join("");
        document.getElementById("lb-list").innerHTML = list;
      });

      initGame();
    </script>
  </body>
</html>
