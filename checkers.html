<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkers (‡∏´‡∏°‡∏≤‡∏Å‡∏Æ‡∏≠‡∏™)</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Kanit", sans-serif;
        text-align: center;
        background: #5d4037;
        color: white;
        margin: 0;
        padding: 20px;
      }

      .home-btn {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.3);
        color: white;
        padding: 5px 15px;
        border-radius: 15px;
        text-decoration: none;
        font-size: 14px;
      }

      h1 {
        margin-bottom: 10px;
        color: #d7ccc8;
        text-shadow: 2px 2px #3e2723;
      }
      #status {
        font-size: 1.2rem;
        margin-bottom: 15px;
        color: #ffcc80;
        min-height: 30px;
      }
      #role-display {
        color: #bcaaa4;
        margin-bottom: 10px;
        font-size: 14px;
      }

      /* ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏´‡∏°‡∏≤‡∏Å‡∏Æ‡∏≠‡∏™ */
      #board {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        grid-template-rows: repeat(8, 1fr);
        width: 90vw;
        max-width: 400px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô */
        aspect-ratio: 1 / 1;
        margin: 0 auto;
        border: 8px solid #3e2723;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
      }

      .cell {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .cell.light {
        background-color: #d7ccc8;
      }
      .cell.dark {
        background-color: #5d4037;
      }

      /* ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
      .cell.selected {
        background-color: #ffb74d !important;
      }

      /* ‡∏ï‡∏±‡∏ß‡∏´‡∏°‡∏≤‡∏Å */
      .piece {
        width: 70%;
        height: 70%;
        border-radius: 50%;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.5);
        position: relative;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .piece:hover {
        transform: scale(1.1);
      }

      .piece.red {
        background: #e53935;
        border: 2px solid #b71c1c;
      }
      .piece.white {
        background: #f5f5f5;
        border: 2px solid #bdbdbd;
      }

      /* ‡∏´‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Æ‡∏≠‡∏™ (King) */
      .piece.king::after {
        content: "üëë";
        font-size: 16px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      #resetBtn {
        margin-top: 20px;
        padding: 10px 20px;
        background: #8d6e63;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: none;
      }
    </style>
  </head>
  <body>
    <a href="/" class="home-btn">üè† ‡∏Å‡∏•‡∏±‡∏ö</a>

    <h1>‚ôö ‡∏´‡∏°‡∏≤‡∏Å‡∏Æ‡∏≠‡∏™ ‚ôî</h1>
    <div id="role-display">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
    <div id="status">‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á...</div>

    <div id="board"></div>

    <button id="resetBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io("/checkers", { transports: ["websocket"] });

      const boardEl = document.getElementById("board");
      const statusEl = document.getElementById("status");
      const roleEl = document.getElementById("role-display");
      const resetBtn = document.getElementById("resetBtn");

      let selectedIndex = null;
      let myRole = null; // 'red' ‡∏´‡∏£‡∏∑‡∏≠ 'white'

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô 8x8 (64 ‡∏ä‡πà‡∏≠‡∏á)
      for (let i = 0; i < 64; i++) {
        const cell = document.createElement("div");
        const row = Math.floor(i / 8);
        const col = i % 8;
        // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ‡∏ä‡πà‡∏≠‡∏á (‡∏î‡∏≥/‡∏Ç‡∏≤‡∏ß)
        const isDark = (row + col) % 2 === 1;
        cell.className = `cell ${isDark ? "dark" : "light"}`;
        cell.dataset.index = i;

        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô
        cell.addEventListener("click", () => handleCellClick(i));
        boardEl.appendChild(cell);
      }

      function handleCellClick(index) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏≤‡πÄ‡∏£‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏î‡∏π ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î
        if (
          statusEl.innerText.indexOf("‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì") === -1 &&
          statusEl.innerText.indexOf("‡∏ä‡∏ô‡∏∞") === -1
        )
          return;

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Server ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏à‡∏∞‡πÄ‡∏î‡∏¥‡∏ô
        if (selectedIndex === null) {
          // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß -> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
          socket.emit("selectPiece", index);
        } else {
          // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß -> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà)
          socket.emit("makeMove", { from: selectedIndex, to: index });
          selectedIndex = null; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß server ‡∏™‡πà‡∏á update ‡∏°‡∏≤)
          document
            .querySelectorAll(".cell")
            .forEach((c) => c.classList.remove("selected"));
        }
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Server
      socket.on("updateBoard", ({ board, turn }) => {
        const cells = document.querySelectorAll(".cell");
        cells.forEach((cell, idx) => {
          cell.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤
          cell.classList.remove("selected");

          if (board[idx]) {
            const p = document.createElement("div");
            p.className = `piece ${board[idx].color} ${
              board[idx].isKing ? "king" : ""
            }`;
            cell.appendChild(p);
          }
        });

        // ‡∏ö‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (myRole === "spectator") {
          statusEl.innerText = `‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢: ${turn === "red" ? "‡πÅ‡∏î‡∏á" : "‡∏Ç‡∏≤‡∏ß"}`;
        } else {
          if (turn === myRole) {
            statusEl.innerText = "‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì! (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏ô)";
            statusEl.style.color = "#81c784";
          } else {
            statusEl.innerText = "‡∏£‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°...";
            statusEl.style.color = "#ffcc80";
          }
        }
      });

      // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Server ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
      socket.on("pieceSelected", (index) => {
        selectedIndex = index;
        document
          .querySelectorAll(".cell")
          .forEach((c) => c.classList.remove("selected"));
        document
          .querySelector(`.cell[data-index="${index}"]`)
          .classList.add("selected");
      });

      socket.on("assignRole", (role) => {
        myRole = role;
        roleEl.innerText =
          role === "spectator"
            ? "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏î‡∏π"
            : `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏µ: ${role === "red" ? "‡πÅ‡∏î‡∏á (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô)" : "‡∏Ç‡∏≤‡∏ß"}`;
      });

      socket.on("gameOver", ({ winner }) => {
        statusEl.innerText = `‡∏à‡∏ö‡πÄ‡∏Å‡∏°! ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏≠ ${
          winner === "red" ? "‡∏™‡∏µ‡πÅ‡∏î‡∏á" : "‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß"
        }`;
        resetBtn.style.display = "inline-block";
      });

      resetBtn.addEventListener("click", () => socket.emit("resetGame"));
    </script>
  </body>
</html>
