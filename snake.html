<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡∏á‡∏π V5.1 (Zigzag Layout)</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Kanit", sans-serif;
        text-align: center;
        background: #e2e1e0;
        margin: 0;
        padding: 10px;
        box-sizing: border-box;
      }

      .screen {
        background: white;
        width: 100%;
        max-width: 500px;
        margin: 0 auto 20px auto;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
      }

      #game-screen {
        display: none;
        flex-direction: column;
        align-items: center;
      }
      #lobby-screen {
        display: none;
      }

      h1,
      h2 {
        margin: 0 0 15px 0;
        font-size: 1.5rem;
      }

      input,
      button {
        font-family: "Kanit";
        margin: 5px 0;
        box-sizing: border-box;
      }
      input[type="text"] {
        padding: 12px;
        width: 100%;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
      }

      .btn-main {
        padding: 12px 0;
        font-size: 18px;
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        width: 100%;
      }
      .btn-green {
        background: #2ed573;
      }
      .btn-blue {
        background: #007bff;
      }
      .btn-main:disabled {
        background: #ccc;
      }

      /* --- Board Styles --- */
      #board-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        aspect-ratio: 1 / 1;
        margin: 10px auto;
        border: 5px solid #4a4a4a;
        border-radius: 5px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        background: #333;
        user-select: none;
        box-sizing: border-box;
      }

      #board {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        grid-template-rows: repeat(10, 1fr);
        width: 100%;
        height: 100%;
      }

      .cell {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: rgba(0, 0, 0, 0.4);
        font-weight: bold;
        z-index: 1;
        position: relative;
      }

      @media (max-width: 380px) {
        .cell {
          font-size: 8px;
        }
      }

      /* ‡∏™‡∏µ‡∏•‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
      .cell:nth-child(odd) {
        background-color: #f7f1e3;
      }
      .cell:nth-child(even) {
        background-color: #d1ccc0;
      }

      /* ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏á‡∏π/‡∏ö‡∏±‡∏ô‡πÑ‡∏î */
      .cell.ladder-start {
        background-color: #c8f7c5 !important;
        border: 1px solid #2ed573;
        box-sizing: border-box;
      }
      .cell.snake-start {
        background-color: #ffc5c5 !important;
        border: 1px solid #ff6b6b;
        box-sizing: border-box;
      }

      /* --- SVG & Token --- */
      #board-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        pointer-events: none;
      }

      .token {
        width: 60%;
        height: 60%;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        position: absolute;
        z-index: 100;
        transition: top 0.6s, left 0.6s;
        transform: translate(-50%, -50%);
      }

      #controls {
        background: #f1f2f6;
        padding: 15px;
        border-radius: 15px;
        width: 100%;
        margin-top: 10px;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <a
      href="/"
      style="
        position: fixed;
        top: 10px;
        left: 10px;
        background: #333;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        text-decoration: none;
        font-family: 'Kanit';
        font-size: 14px;
        z-index: 9999;
      "
    >
      üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°
    </a>
    <div id="login-screen" class="screen">
      <h1>üêç ‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡∏á‡∏π V5.1</h1>
      <p>Layout ‡πÅ‡∏ö‡∏ö ZigZag</p>
      <input
        type="text"
        id="nameInput"
        placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô..."
        maxlength="10"
      />
      <button id="joinBtn" class="btn-main btn-blue">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Lobby</button>
    </div>

    <div id="lobby-screen" class="screen">
      <h2>üè† ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</h2>
      <ul
        id="player-list"
        style="list-style: none; padding: 0; text-align: left"
      ></ul>
      <button id="startBtn" class="btn-main btn-green" disabled>
        ‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...
      </button>
    </div>

    <div
      id="game-screen"
      class="screen"
      style="
        max-width: 100%;
        background: transparent;
        padding: 0;
        box-shadow: none;
      "
    >
      <div id="board-container">
        <div id="board"></div>
        <svg id="board-svg">
          <defs>
            <marker
              id="arrow-green"
              markerWidth="6"
              markerHeight="6"
              refX="5"
              refY="3"
              orient="auto"
              markerUnits="strokeWidth"
            >
              <path d="M0,0 L0,6 L6,3 z" fill="#2ed573" />
            </marker>
            <marker
              id="arrow-red"
              markerWidth="6"
              markerHeight="6"
              refX="5"
              refY="3"
              orient="auto"
              markerUnits="strokeWidth"
            >
              <path d="M0,0 L0,6 L6,3 z" fill="#ff6b6b" />
            </marker>
          </defs>
        </svg>
      </div>

      <div
        id="controls"
        class="screen"
        style="max-width: 500px; margin-top: 20px"
      >
        <h2 id="turn-status">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</h2>
        <button id="rollBtn" class="btn-main btn-blue" disabled>
          üé≤ ‡∏ó‡∏≠‡∏¢‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤
        </button>
        <div id="dice-result" style="margin-top: 10px; font-weight: bold"></div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io("/snake", {
        transports: ["websocket", "polling"],
      });

      const screens = {
        login: document.getElementById("login-screen"),
        lobby: document.getElementById("lobby-screen"),
        game: document.getElementById("game-screen"),
      };
      const els = {
        name: document.getElementById("nameInput"),
        join: document.getElementById("joinBtn"),
        list: document.getElementById("player-list"),
        start: document.getElementById("startBtn"),
        board: document.getElementById("board"),
        svg: document.getElementById("board-svg"),
        roll: document.getElementById("rollBtn"),
        status: document.getElementById("turn-status"),
        result: document.getElementById("dice-result"),
      };

      const jumps = {
        2: 23,
        8: 12,
        17: 93,
        29: 54,
        32: 51,
        39: 80,
        70: 89,
        75: 96,
        99: 4,
        92: 76,
        85: 6,
        73: 15,
        61: 18,
        55: 24,
        42: 10,
      };

      let cellCoords = {};
      let latestPlayers = [];

      // --- Logic ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö ZIGZAG (‡∏™‡∏•‡∏±‡∏ö‡∏ü‡∏±‡∏ô‡∏õ‡∏•‡∏≤) ---
      // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ß‡∏ô‡∏•‡∏π‡∏õ Row 0-9 ‡πÅ‡∏•‡∏∞ Col 0-9
      for (let row = 0; row < 10; row++) {
        for (let col = 0; col < 10; col++) {
          let num;

          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏π‡πà (0, 2, 4...) ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏á ‡∏ã‡πâ‡∏≤‡∏¢ -> ‡∏Ç‡∏ß‡∏≤
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏µ‡πà (1, 3, 5...) ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏á ‡∏Ç‡∏ß‡∏≤ -> ‡∏ã‡πâ‡∏≤‡∏¢
          if (row % 2 === 0) {
            num = row * 10 + col + 1;
          } else {
            num = (row + 1) * 10 - col;
          }

          const cell = document.createElement("div");
          cell.className = "cell";
          cell.id = `cell-${num}`; // ‡πÑ‡∏≠‡∏î‡∏µ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÄ‡∏ä‡πà‡∏ô 1, 2, 20, 19)
          cell.innerText = num;

          if (jumps[num])
            cell.classList.add(
              jumps[num] > num ? "ladder-start" : "snake-start"
            );
          els.board.appendChild(cell);
        }
      }

      // --- Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Responsive) ---
      function updateLayout() {
        const sampleCell = document.querySelector(".cell"); // ‡∏´‡∏¢‡∏¥‡∏ö‡∏°‡∏≤‡∏™‡∏±‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î
        const cellWidth = sampleCell.offsetWidth;
        const cellHeight = sampleCell.offsetHeight;
        const halfW = cellWidth / 2;
        const halfH = cellHeight / 2;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á
        for (let i = 1; i <= 100; i++) {
          const cell = document.getElementById(`cell-${i}`);
          if (cell) {
            // offsetTop/Left ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏Ç‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Å‡πá‡∏ï‡∏≤‡∏°
            cellCoords[i] = {
              top: cell.offsetTop + halfH,
              left: cell.offsetLeft + halfW,
            };
          }
        }

        drawConnectors();

        latestPlayers.forEach((p, idx) => {
          const t = getOrCreateToken(p.id, p.color);

          // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î token
          const tokenSize = Math.max(10, cellWidth * 0.5);
          t.style.width = `${tokenSize}px`;
          t.style.height = `${tokenSize}px`;

          moveTokenTo(t, p.pos);

          const offset = cellWidth * 0.1;
          if (latestPlayers.filter((pl) => pl.pos === p.pos).length > 1) {
            t.style.transform = `translate(calc(-50% + ${
              idx * offset
            }px), calc(-50% + ${idx * offset}px))`;
          } else {
            t.style.transform = `translate(-50%, -50%)`;
          }
        });
      }

      function drawConnectors() {
        const oldLines = els.svg.querySelectorAll("line");
        oldLines.forEach((l) => l.remove());

        for (let [start, end] of Object.entries(jumps)) {
          if (cellCoords[start] && cellCoords[end]) {
            const c1 = cellCoords[start];
            const c2 = cellCoords[end];

            const isLadder = parseInt(end) > parseInt(start);
            const color = isLadder ? "#2ed573" : "#ff6b6b";
            const lineWidth =
              window.innerWidth < 400 ? (isLadder ? 2 : 1.5) : isLadder ? 4 : 2;
            const opacity = 0.5;
            const marker = isLadder ? "url(#arrow-green)" : "url(#arrow-red)";

            const line = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line"
            );
            line.setAttribute("x1", c1.left);
            line.setAttribute("y1", c1.top);
            line.setAttribute("x2", c2.left);
            line.setAttribute("y2", c2.top);
            line.setAttribute("stroke", color);
            line.setAttribute("stroke-width", lineWidth);
            line.setAttribute("stroke-opacity", opacity);
            line.setAttribute("stroke-linecap", "round");
            line.setAttribute("marker-end", marker);
            if (isLadder) line.setAttribute("stroke-dasharray", "4,4");
            else line.setAttribute("stroke-dasharray", "2,2");

            els.svg.appendChild(line);
          }
        }
      }

      window.addEventListener("resize", updateLayout);

      function getOrCreateToken(id, color) {
        let t = document.getElementById(`token-${id}`);
        if (!t) {
          t = document.createElement("div");
          t.id = `token-${id}`;
          t.className = "token";
          t.style.backgroundColor = color;
          document.getElementById("board-container").appendChild(t);
        }
        return t;
      }

      function moveTokenTo(t, pos) {
        if (cellCoords[pos]) {
          t.style.top = `${cellCoords[pos].top}px`;
          t.style.left = `${cellCoords[pos].left}px`;
        }
      }

      // --- Socket Logic ---
      els.join.onclick = () => {
        if (!els.name.value) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô!");
        socket.emit("joinGame", els.name.value);
        els.join.innerText = "...";
      };

      socket.on("loginSuccess", () => {
        screens.login.style.display = "none";
        screens.lobby.style.display = "block";
      });
      socket.on("lobbyUpdate", ({ players, hostId }) => {
        els.list.innerHTML = players
          .map(
            (p) =>
              `<li><span style="width:15px;height:15px;background:${p.color};display:inline-block;border-radius:50%;margin-right:10px;"></span>${p.name}</li>`
          )
          .join("");
        if (socket.id === hostId) {
          els.start.disabled = players.length < 2;
          els.start.innerText = players.length < 2 ? "‡∏£‡∏≠‡∏Ñ‡∏ô..." : "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!";
          els.start.onclick = () => socket.emit("startGame");
        } else {
          els.start.disabled = true;
          els.start.innerText = "‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á...";
        }
      });

      socket.on("gameStarted", () => {
        screens.lobby.style.display = "none";
        screens.game.style.display = "flex";
        setTimeout(updateLayout, 100);
      });

      els.roll.onclick = () => socket.emit("rollDice");

      socket.on("animateTurn", (data) => {
        els.roll.disabled = true;
        els.status.innerText = `... ${data.msg.split(" ")[0]} ‡πÄ‡∏î‡∏¥‡∏ô`;
        els.result.innerText = data.msg;
        els.result.style.color =
          data.jumpType === "snake"
            ? "#ff6b6b"
            : data.jumpType === "ladder"
            ? "#2ed573"
            : "black";

        const t = getOrCreateToken(data.playerId, "gray");
        moveTokenTo(t, data.midPos);
        if (data.jumpType) setTimeout(() => moveTokenTo(t, data.finalPos), 800);
      });

      socket.on("updateState", ({ players, currentTurn, movingPlayerId }) => {
        latestPlayers = players;
        updateLayout();
        if (socket.id === currentTurn) {
          els.status.innerText = "‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì!";
          els.roll.disabled = false;
        } else {
          els.status.innerText = `‡∏£‡∏≠ ${
            players.find((p) => p.id === currentTurn)?.name
          }`;
          els.roll.disabled = true;
        }
      });

      socket.on("gameOver", ({ winner }) =>
        setTimeout(() => alert(`${winner} ‡∏ä‡∏ô‡∏∞!`), 500)
      );
      socket.on("gameReset", () => location.reload());
      socket.on("notification", alert);
    </script>
  </body>
</html>
